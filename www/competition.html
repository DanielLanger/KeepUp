<!DOCTYPE html>
<html>
<head>
<title>My Competitions</title>
<link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="css/style.css" rel="stylesheet" media="screen">

<script type="text/javascript"
	src="http://code.jquery.com/jquery-latest.min.js"></script>

<script type="text/javascript">
	var request;
	var request2;
	var request3;
	$(document).ready(function() {

		var compCreator;
		var compChallenger = [];
		var isObserver;
		var compName;
		var compExp;
		var compDes;
		var compEv;
		var compID;
		var creatorName;
		var challengedName = "";
		var allNames= []
		var allIds = []
		request = $
				.ajax({
					url : "http://192.168.56.1:3000/webservice.php",
					type : "post",
					data : {
						action : 'getComp',
						comp_id : localStorage.getItem("current_comp")
					},
					success : function(data) {
						console.log(data);
						var compArray = JSON.parse(data.competitions);

						allNames.push(compArray[0].creator_username);
						allIds.push(compArray[0].creator);
						compName = compArray[0].title;
						$("#result").append(compName);
						compExp = compArray[0].expiration;
						compDes = compArray[0].description;
						compCreator = compArray[0].creator;
						compEv = compArray[0].required_evidence;
						compID = compArray[0].id;
						for (var i = 0; i < compArray.length - 1; i++) {
							compChallenger[i] = compArray[i + 1].user_id;
							allIds.push(compChallenger[i]);
						}

						request2 = $
								.ajax({
									url : "http://192.168.56.1:3000/webservice.php",
									type : "post",
									data : {
										action : 'getUser',
										user_id : compCreator
									},
									success : function(data) {
										console.log(data);
										var compArray2 = JSON.parse(data.competitions);
										creatorName = compArray2[0].username;

										request3 = $
												.ajax({
													url : "http://192.168.56.1:3000/webservice.php",
													type : "post",
													data : {
														action : 'getUsers',
														user_id : compChallenger
													},
													success : function(data) {
														console.log(data);
														var compArray3 = JSON.parse(data.challengers);
														//challengedName = compArray3[0].username + ", ";
														for (var i = 0; i < compArray3.length; i++) {
															if (i == 0) {
																challengedName = compArray3[i].username;

															} else {
																challengedName = challengedName + ", " + compArray3[i].username;
															}
															allNames.push(compArray3[i].username);
														}

														$("#competitionDiv")
																.append(
																		"<div style='border-style:solid;border-width:1px' onclick=goToComp("
																				+ compID
																				+ ")>"
																				+ compDes
																				+ "<br><br>"
																				+ "Expires: "
																				+ compExp
																				+ "<br><br>"
																				+ "Creator: "
																				+ creatorName
																				+ "<br>"
																				+ "Challengers: "
																				+ challengedName
																				+ "</div>");

														$.ajax({
												      url: "http://192.168.56.1:3000/webservice.php",
												      type: "post",
												      data: {action:'isObserver', user_id: localStorage.getItem("current_userid"), competition_id : localStorage.getItem("current_comp")},
												      success:function(data){
												          if(data.stat == "success") {
												          	console.log(data);
												          	if(JSON.parse(data.observer)==true || compCreator == localStorage.getItem("current_userid") || compChallenger.indexOf(localStorage.getItem("current_userid")) > -1) {
												          		$("#buttonDiv").append("<button class='btn-link' onclick=observe() id=observeButton disabled><i class='icon-eye-open' style='opacity:0.4'></i></button>");
												          	} else {
												          		$("#buttonDiv").append("<button class='btn-link' onclick=observe() id=observeButton><i class='icon-eye-open icon-white'></i></button>");
												          	}
												          	if(allIds.indexOf(localStorage.getItem("current_userid")) < 0) {
												          		$.ajax({
																	      url: "http://192.168.56.1:3000/webservice.php",
																	      type: "post",
																	      data: {action:'hasVoted', user_id: localStorage.getItem("current_userid"), competition_id : localStorage.getItem("current_comp")},
																	      success:function(data){
																          if(data.stat == "success") {
																          	console.log(data);
																          	if(JSON.parse(data.hasVoted)==false) {
																          		var s = $('<select />');
																          		s.attr('id', 'voteDropdown');
																							for(var x  = 0; x <allNames.length; x++) {
																							    $('<option />', {value: allIds[x], text: allNames[x]}).appendTo(s);
																							}
																							$('#pickSideDiv').append("Pick Who You Think Will Win!");
																							$('#pickSideDiv').append(s);
																							$('#pickSideDiv').append("<button onclick=submitVote()>Submit</button>");
																          	} else {
																          		var s = $('<select />');
																          		s.attr('id', 'voteDropdown');
																          		s.attr('disabled', true);
																							for(var x  = 0; x <allNames.length; x++) {
																							    $('<option />', {value: allIds[x], text: allNames[x]}).appendTo(s);
																							}
																							s.val(JSON.parse(data.contestant));
																							$('#pickSideDiv').append("Pick Who You Think Will Win!");
																							$('#pickSideDiv').append(s);
																          	}
																          }  else {
																            console.log("Failed!")
																            console.log(data.code);
																          }
																	      }
																	  });
													        }
													      }
													    }
												  	});
													},
													error : function(err) {
														console.log("Failed!")
														console.log(err);
													}
												});

									},
									error : function(err) {
										console.log("Failed!")
										console.log(err);
									}
								});

					},
					error : function(err) {
						console.log("Failed!")
						console.log(err);
					}
				});

		getCompVotes();	
	});

	function myComps() {
		window.location.href = 'myCompetitions.html';
	}

	function observe() {
		$.ajax({
      url: "http://192.168.56.1:3000/webservice.php",
      type: "post",
      data: {action:'addObserver', user_id: localStorage.getItem("current_userid"), competition_id: localStorage.getItem("current_comp")},
      success:function(data){
          if(data.stat == "success") {
          		console.log(data);
              window.location.href = 'competition.html';
          } else {
              console.log("Failed!")
              console.log(data.code);
              $("#error").html(data.code);
          }
      }, error:function(err){
          console.log("Failed!")
          console.log(err);
      }
  	});
	}

	function submitVote() {
		var selectedID = $("#voteDropdown").val();
		console.log(selectedID);
		$.ajax({
      url: "http://192.168.56.1:3000/webservice.php",
      type: "post",
      data: {action:'submitVote', user_id: localStorage.getItem("current_userid"), competition_id: localStorage.getItem("current_comp"), contestant: selectedID},
      success:function(data){
          if(data.stat == "success") {
          		console.log(data);
              window.location.href = 'competition.html';
          } else {
              console.log("Failed!")
              console.log(data.code);
              $("#error").html(data.code);
          }
      }, error:function(err){
          console.log("Failed!")
          console.log(err);
      }
  	});

	}

	function getCompVotes() {
		$.ajax({
      url: "http://192.168.56.1:3000/webservice.php",
      type: "post",
      data: {action:'getCompVotes', competition_id: localStorage.getItem("current_comp")},
      success:function(data){
          if(data.stat == "success") {
          	console.log(data);
            var voteData = JSON.parse(data.voteArray);
            for(var k in voteData) {
            	$('#votesTable tr:last').after("<tr><td>" + k + "</td><td style='text-align: center;'>" + voteData[k] + "</td></tr>");
            }
              
          } else {
              console.log("Failed!")
              console.log(data.code);
              $("#error").html(data.code);
          }
      }, error:function(err){
          console.log("Failed!")
          console.log(err);
      }
  	});
	}

	function goHome() {
		window.location.href = 'home.html';
	}

</script>
</head>


<body>
	<div class="container page-dark">
		<div class="wrapper">
			<div class="header">
				<button class="btn-link" onclick="myComps()" style="float: left; width: 10%; margin: 5px;"><i class="icon-arrow-left"></i>
				</button>
				<h4 id="result" style="display: inline-block"></h4>
				<span id="buttonDiv" style="display: inline; float: right; width: 10%; margin: 6px">
				</span>
			</div>

			<div class="container-overflow">
				
				<!--         
				<button onclick="getPhoto(pictureSource.PHOTOLIBRARY);">From Photo Library</button><br>
				<img style="display:none;" id="largeImage" src="" />
				-->

				<div id="competitionDiv">
					
				</div>

				<div id="pickSideDiv">
				</div>

				<table id = "votesTable" border="1">
					<tr>
				  	<th>Contestant</th>
				  	<th>Votes</th>
					</tr>
					<tr>
					</tr>
				</table>
			</div>

			<div class="push"></div>
		</div>

		<div class="footer">
			<button class="btn-link btn-footer-home" onclick="goHome()">
                <i class="icon-home icon-white"></i>
            </button>
        </div>
	</div>
</body>
</html>
